<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="robots" content="noindex,nofollow,noarchive" />
    <meta name="referrer" content="no-referrer" />

    <script>
      MathJax = {
        chtml: {
          displayAlign: "left",
          displayIndent: "1em",
        },
      };
    </script>

    

    <link rel="icon" href="favicon.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c"
    />
    <link rel="stylesheet" href="style.css" />

    <title>第10回 4I-データベース工学</title>
  </head>

  <body>
    <div class="openbtn"><span></span><span></span><span></span></div>
    <nav id="g-nav">
      <div id="g-nav-list">
        <!-- ---------------------------------------- -->
         <ul>
<li><a href="#連絡と準備" id="toc-連絡と準備"><span class="toc-section-number">1</span>
連絡と準備</a>
<ul>
<li><a href="#ハンズオン学習の準備" id="toc-ハンズオン学習の準備"><span
class="toc-section-number">1.1</span> ハンズオン学習の準備</a></li>
<li><a href="#今回の講義の概要" id="toc-今回の講義の概要"><span
class="toc-section-number">1.2</span> 今回の講義の概要</a></li>
</ul></li>
<li><a href="#準備" id="toc-準備"><span class="toc-section-number">2</span> 準備</a></li>
<li><a href="#サブクエリ-副問い合わせ" id="toc-サブクエリ-副問い合わせ"><span
class="toc-section-number">3</span> サブクエリ (副問い合わせ)</a>
<ul>
<li><a href="#where句におけるサブクエリの利用" id="toc-where句におけるサブクエリの利用"><span
class="toc-section-number">3.1</span> WHERE句におけるサブクエリの利用</a></li>
<li><a href="#select句におけるサブクエリの利用" id="toc-select句におけるサブクエリの利用"><span
class="toc-section-number">3.2</span> SELECT句におけるサブクエリの利用</a></li>
<li><a href="#サブクエリを利用する場合の注意点" id="toc-サブクエリを利用する場合の注意点"><span
class="toc-section-number">3.3</span> サブクエリを利用する場合の注意点</a></li>
</ul></li>
<li><a href="#内部結合" id="toc-内部結合"><span class="toc-section-number">4</span>
内部結合</a></li>
<li><a href="#授業時間外学習の指示" id="toc-授業時間外学習の指示"><span
class="toc-section-number">5</span> 授業時間外学習の指示</a></li>
</ul> 
        <!-- ---------------------------------------- -->
      </div>
    </nav>

    <header class="markdown-body">
      <p>2025-4I データベース工学 第10回 講義資料</p>
      <p>2025年12月18日 (木) 3-4時限</p>
    </header>

    <main class="markdown-body">
      <!-- ---------------------------------------- -->
      <h1 data-number="1" id="連絡と準備"><span class="header-section-number">1</span>
      連絡と準備</h1>
      <ul>
      <li><strong>小テスト❼</strong> を実施します。
      <ul>
      <li>シラバス記載のように、小テストは最終評価の <span class="masked">35%</span>
      に相当します。</li>
      <li>遅刻・欠席等により追試験を希望する場合は<a
      href="lecture01.html#成績評価法と履修上の注意">第01回講義で案内した手続き</a>をしてください。</li>
      </ul></li>
      <li><strong>Unity 1-Week GAME JAM</strong>
      <ul>
      <li><a href="https://unityroom.com/unity1weeks">https://unityroom.com/unity1weeks</a></li>
      <li>次回の開催 12月22日(月) 0時 〜 12月28日(日) 20時 … お題「？？？？」</li>
      </ul></li>
      </ul>
      <h2 data-number="1.1" id="ハンズオン学習の準備"><span class="header-section-number">1.1</span>
      ハンズオン学習の準備</h2>
      <p>次の手順でSQL演習環境の立ち上げと、教材の更新を取得してください。</p>
      <ul>
      <li><a href="lecture04.html#sql演習環境の動作確認-前回復習">SQL演習環境の動作確認</a>@
      第04回講義</li>
      <li><a href="lecture04.html#教材の更新の取得">教材の更新の取得</a>@ 第04回講義</li>
      </ul>
      <h2 data-number="1.2" id="今回の講義の概要"><span class="header-section-number">1.2</span>
      今回の講義の概要</h2>
      <p><a
      href="lecture07.html">第07回講義</a>では、データの冗長性を排除し、効率的かつ一貫性のある構造を実現するために、情報を複数のテーブルに分解する
      正規化 について学びました。また、<a
      href="lecture09.html">第09回講義</a>では、具体的なテーブル定義 (<code>CREATE TABLE</code>)
      と、<u>それらのテーブル同士を整合性を保ちながら関連付けるため</u>
      の<strong>外部キー制約</strong> (<code>REFERENCES</code>) について学びました。</p>
      <p>ここからの講義では、複数のテーブルに分散しているデータを対象に、<u>それらを組み合わせて情報を引き出すクエリ
      (問い合わせ)</u> について学んでいきます。具体的には、<strong><em>サブクエリ</em></strong>
      (副問い合わせ) と、<strong><em>内部結合</em></strong>・<strong><em>外部結合</em></strong>
      によるデータ取得について学んでいきます。</p>
      <h1 data-number="2" id="準備"><span class="header-section-number">2</span> 準備</h1>
      <p>演習環境の <code>from-teacher/10/create-x_db.sql</code>
      を実行して、次のテーブル群を作成してください。</p>
      <ul>
      <li>x_items</li>
      <li>x_jobs</li>
      <li>x_characters</li>
      <li>x_guilds</li>
      <li>x_guild_characters</li>
      <li>x_character_items</li>
      <li>x_gold_transfers</li>
      </ul>
      <p>実行後、<code>create-x_db.sql</code>
      を読解して「<u>各テーブルがどのようなカラムを持っているか</u>」、「<u>外部キー制約によってどのように紐付いているか</u>」を確認してください。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>RDBに関する質問です。SQL
      を読んでいたら「XXXのマスタテーブル」や「XXXに関するトランザクションテーブル」というコメントが書かれていました。「マスタテーブル」と「トランザクションテーブル」とは何ですか？性質や役割が違うのですか？</p>
      </blockquote>
      <blockquote>
      <p>「マスタテーブル」と「トランザクションテーブル」という文脈において、それらは SQL の
      <code>START TRANSACTION</code> / <code>COMMIT</code> とは関係ありますか？</p>
      </blockquote>
      <p>つづいて <code>from-teacher/10/insert-x_db_01.sql</code>
      を実行して、各テーブルにレコードを挿入してください
      (※意図的にレコードを挿入していないテーブルもあります)。また <code>insert-x_db_01.sql</code>
      を読解してください。</p>
      <h3 data-number="2.0.1" id="演習"><span class="header-section-number">2.0.1</span> 演習</h3>
      <ul>
      <li><code>create-x_db.sql</code> の内容に基づき「論理ER図」を作成してください。
      <ul>
      <li><strong>作成例</strong> : <a href="figs/10/LER-01.png">こちら</a></li>
      </ul></li>
      </ul>
      <h3 data-number="2.0.2" id="定着確認"><span class="header-section-number">2.0.2</span>
      定着確認</h3>
      <p><code>create-x_db.sql</code> で定義されるテーブル群について、次の各問いに答えよ。</p>
      <ul>
      <li>あるアイテム (たとえば <code>Potion</code>) を所持しているキャラが存在する場合、x_items
      テーブルから、そのアイテム (＝ <code>Potion</code>)
      のレコードを削除することはできない。この解釈は「適切である」か「適切ではない」かを答えよ。
      <ul>
      <li><strong>答え</strong> : <span
      class="masked">適切である。<code>x_character_items.item_id</code> は
      <code>x_items.item_id</code> を参照しているが、<code>ON DELETE CASCADE</code> も
      <code>SET NULL</code>
      も設定していない。そのため、参照先を消そうとするとFK違反により削除に失敗する。</span></li>
      </ul></li>
      <li>x_characters テーブルからキャラクタを削除すると、そのキャラが所有しているギルドも x_guilds
      から自動的に削除される。この解釈は「適切である」か「条件付きで適切である」か「適切ではない」かを答えよ。
      <ul>
      <li><strong>答え</strong> : <span
      class="masked">条件付きで適切である。<code>x_guilds.owner_id</code> は
      <code>x_characters.character_id</code> を <code>ON DELETE CASCADE</code> で参照しているため
      (キャラの削除が成立した場合は) そのキャラが所有するギルドは自動的に削除される。ただし
      <code>x_gold_transfers</code> がキャラを参照しており <code>ON DELETE</code>
      が未指定であるため、送受信履歴が残っているキャラはFK違反により削除できない。</span></li>
      </ul></li>
      <li>x_guilds テーブルからギルドを削除すると、x_guild_characters
      テーブルのなかで、そのギルドを参照したレコードも自動的に削除される。この解釈は「適切である」か「適切ではない」かを答えよ。
      <ul>
      <li><strong>答え</strong> : <span class="masked">適切である。</span></li>
      </ul></li>
      <li>x_jobs テーブルからジョブを削除すると、x_characters
      テーブルのなかで、そのジョブを参照していたキャラクタのレコードも自動的に削除される。この解釈は「適切である」か「適切ではない」かを答えよ。
      <ul>
      <li><strong>答え</strong> : <span class="masked">適切ではない。</span></li>
      </ul></li>
      <li>x_characters
      テーブルから、あるキャラクタの削除が成功したとき、そのキャラが所有していたギルドも x_guilds
      から自動的に削除され、さらに x_guild_characters
      テーブルで、そのギルドを参照していたレコードも自動的に削除される。この解釈は「適切である」か「条件付きで適切である」か「適切ではない」かを答えよ。
      <ul>
      <li><strong>答え</strong> : <span class="masked">適切である。</span></li>
      </ul></li>
      <li>x_gold_transfers テーブルには、from_character_id と to_character_id の両方が NULL
      のレコードを挿入することはできない。この解釈は「適切である」か「適切ではない」かを答えよ。
      <ul>
      <li><strong>答え</strong> : <span class="masked">適切である。</span></li>
      </ul></li>
      <li>x_gold_transfers テーブルには、from_character_id と to_character_id
      が同じ値のレコードを挿入することはできない。この解釈は「適切である」か「適切ではない」かを答えよ。
      <ul>
      <li><strong>答え</strong> : <span class="masked">適切である。</span></li>
      </ul></li>
      </ul>
      <h3 data-number="2.0.3" id="sqlドリル"><span class="header-section-number">2.0.3</span>
      SQLドリル💻</h3>
      <ul>
      <li><code>ex-01_1.sql</code> 👉 x_items
      テーブルのすべてのレコードについて、次に示すようなカラムを出力する SQL
      を記述せよ。ただし、item_id の昇順で整列すること。</li>
      </ul>
      <pre><code> item_id |       name       | price | weight_kg |     description      
---------+------------------+-------+-----------+----------------------
       1 | Potion           |   200 |       0.2 | 単体HPを小回復
       2 | High Potion      |   600 |       0.2 | 単体HPを中回復
       3 | Mega Potion      |  1200 |       0.3 | 単体HPを大回復
       4 | Giga Potion      |  4000 |       0.3 | 単体HPを完全回復
       5 | Mana Potion      |  1000 |       0.1 | 単体MPを小回復
       6 | High Mana Potion |  5000 |       0.2 | 単体MPを大回復
       7 | Antidote         |   300 |       0.1 | 毒状態を回復
       8 | Paralyze Cure    |   600 |       0.1 | 麻痺状態を回復
       9 | Angel Feather    |  1200 |       0.1 | 戦闘不能を回復
      10 | Chimera Wing     |   500 |       0.1 | 指定の街に瞬間移動
      11 | Torch            |   820 |       1.5 | 洞窟内を明るく照らす
      12 | Climbing Rope    |  1000 |       1.5 | 崖や段差を乗り越える</code></pre>
      <ul>
      <li><code>ex-01_2.sql</code> 👉 x_jobs
      テーブルのすべてのレコードについて、次に示すようなカラムを出力する SQL
      を記述せよ。ただし、job_id の昇順で整列すること。</li>
      </ul>
      <pre><code> job_id |  name   
--------+---------
      1 | Fighter
      2 | Monk
      3 | Ninja
      4 | Samurai
      5 | Priest
      6 | Wizard</code></pre>
      <ul>
      <li><code>ex-01_3.sql</code> 👉 x_character_items
      テーブルのすべてのレコードについて、次に示すようなカラムを出力する SQL
      を記述せよ。ただし、第1キーを <strong>item_id</strong> (昇順)、第2キーを
      <strong>character_id</strong> (昇順) として整列すること。</li>
      </ul>
      <pre><code> item_id | character_id | qty 
---------+--------------+-----
       1 |            1 |   2
       1 |            4 |   1
       1 |            7 |  10
       1 |            9 |   1
       1 |           15 |   2
       2 |            5 |   2
       2 |           14 |   1
       3 |            2 |   1
       3 |           12 |   1
 ～～以下略～～</code></pre>
      <ul>
      <li><code>ex-01_4.sql</code> 👉 x_character_items
      テーブルから、各アイテムを所持するキャラの人数、各アイテムの所持総数
      (＝全キャラの所持数の合計) を集計して出力する SQL を記述せよ。ただし、<strong>item_id</strong>
      の昇順で整列すること。
      <ul>
      <li>x_character_items には、item_id が <code>4</code>、<code>8</code>
      のレコードが存在しないため、次のような結果になることに注意すること。</li>
      <li><strong>ヒント</strong>: <span class="masked">GROUP BY 句、集約関数 SUM、COUNT
      を利用</span></li>
      </ul></li>
      </ul>
      <pre><code> item_id | 所持キャラ数 | 所持総数 
---------+--------------+----------
       1 |            5 |       16
       2 |            2 |        3
       3 |            3 |        3
       5 |            3 |        9
       6 |            3 |        4
       7 |            5 |        8
       9 |            5 |        6
      10 |            6 |        7
      11 |            5 |        9
      12 |            1 |        1
(10 行)</code></pre>
      <ul>
      <li><code>ex-01_5.sql</code> 👉 x_character_items
      テーブルから、各アイテムの所持総数を集計して出力せよ。ただし、次のように所持総数が6個以上のレコードについて、<strong>item_id</strong>
      の昇順で整列して出力する SQL を記述せよ。
      <ul>
      <li><strong>ヒント</strong>: <span class="masked">HAVING 句を利用</span></li>
      </ul></li>
      </ul>
      <pre><code> item_id | 所持総数 
---------+----------
       1 |       16
       5 |        9
       7 |        8
       9 |        6
      10 |        7
      11 |        9
(6 行)</code></pre>
      <ul>
      <li><code>ex-01_6.sql</code> 👉 x_jobs テーブルから name が <code>Priest</code> であるジョブの
      job_id を出力する SQL を記述せよ。
      <ul>
      <li><strong>ヒント</strong>: <span class="masked">WHERE 句を利用</span></li>
      </ul></li>
      </ul>
      <pre><code> job_id 
--------
      5
(1 行)</code></pre>
      <h1 data-number="3" id="サブクエリ-副問い合わせ"><span class="header-section-number">3</span>
      サブクエリ (副問い合わせ)</h1>
      <p>SQLにおける <strong>サブクエリ</strong> (<strong>副問い合わせ</strong>) とは、ある SQL
      文の内部に「入れ子」として記述される <code>SELECT</code>
      文のことを意味します。これにより、1つのクエリのなかで
      <u>複数テーブルにまたがる検索条件や、集計結果</u> を扱うことが可能になります。</p>
      <p>サブクエリは、主に <span class="masked">WHERE 句や SELECT 句</span>
      などの一部として利用されます。</p>
      <h2 data-number="3.1" id="where句におけるサブクエリの利用"><span
      class="header-section-number">3.1</span> WHERE句におけるサブクエリの利用</h2>
      <p>たとえば、正規化によって「キャラクタデータ」と「ジョブデータ」が別々のテーブルに分解されている状況を考えます。このとき「<u><strong>ジョブが
      Wizard または Priest
      であるキャラの名前を取得したい</strong></u>」という要求があるとします。</p>
      <p>この要求を原始的に実現しようとすると
      (＝<strong>「サブクエリ」や「結合」を使用せずに実現しようとすると</strong>) 、まずは x_jobs
      に対して該当する <strong>job_id</strong> を取得するために、次のような SQL
      を発行する必要があります。</p>
      <div class="sourceCode" id="cb7" data-caption="Wizard と Priest の job_id を取得"><pre
      class="sourceCode numberSource sql numberLines"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">SELECT</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  job_id</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">FROM</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  x_jobs</span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="kw">WHERE</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  name <span class="kw">IN</span> (<span class="st">&#39;Wizard&#39;</span>, <span class="st">&#39;Priest&#39;</span>);</span></code></pre></div>
      <p>この SQL の実行結果から、以下のように Wizard と Priest に対応する <strong>job_id</strong>
      (ここでは <code>5</code> と <code>6</code>) を得ます。</p>
      <pre><code> job_id 
--------
      5
      6
(2 行)</code></pre>
      <p>つづいて、この結果をもとに、x_characters テーブルに対して次のような SQL
      を発行し、<strong>条件に一致するキャラクタ情報を取得する</strong> という
      <u><strong>2段階の手順</strong></u> を踏むことになります。</p>
      <div class="sourceCode" id="cb9"
      data-caption="job_id が 5 と 6 のキャラクタの id, name, job_id を取得"><pre
      class="sourceCode numberSource sql numberLines"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">SELECT</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  character_id,</span>
<span id="cb9-3"><a href="#cb9-3"></a>  name,</span>
<span id="cb9-4"><a href="#cb9-4"></a>  job_id</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="kw">FROM</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  x_characters</span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="kw">WHERE</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  job_id <span class="kw">IN</span> (<span class="dv">5</span>, <span class="dv">6</span>) <span class="co">-- 先の実行結果から手作業で値を転記</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>  character_id;</span></code></pre></div>
      <p>▼ 実行結果</p>
      <pre><code> character_id |  name   | job_id
--------------+---------+--------
            1 | Marvin  |      5
            3 | Charlie |      6
            6 | Alice   |      5
           11 | Ellen   |      6
           13 | Mallet  |      6
           15 | Trent   |      5
           18 | Carol   |      5
           19 | Jack    |      6
(8 行)</code></pre>
      <p>このような手続きは煩雑になりやすく、特に <strong>第08行目</strong> のように、別の SQL
      の実行結果を手作業で転記する場合、ミスが起こりやすいという問題があります。ここでは
      2個の整数値を転記していますが <span class="masked">1000個の UUID</span>
      を転記するような状況は現実的ではありません。</p>
      <p>サブクエリは、このような問題を解消するために有効に利用できます。サブクエリを用いることで、以下の
      SQL のように <strong>1つのクエリのなかで、x_characters と x_jobs
      にまたがる検索条件を記述することが可能</strong> となります。</p>
      <div class="sourceCode" id="cb11" data-caption="WHERE句にサブクエリを用いた例"><pre
      class="sourceCode numberSource sql numberLines"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">SELECT</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>  character_id,</span>
<span id="cb11-3"><a href="#cb11-3"></a>  name,</span>
<span id="cb11-4"><a href="#cb11-4"></a>  job_id</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="kw">FROM</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>  x_characters</span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="kw">WHERE</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>  job_id <span class="kw">IN</span> (</span>
<span id="cb11-9"><a href="#cb11-9"></a>    <span class="kw">SELECT</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>      job_id</span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="kw">FROM</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>      x_jobs</span>
<span id="cb11-13"><a href="#cb11-13"></a>    <span class="kw">WHERE</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>      name <span class="kw">IN</span> (<span class="st">&#39;Wizard&#39;</span>, <span class="st">&#39;Priest&#39;</span>)</span>
<span id="cb11-15"><a href="#cb11-15"></a>  )</span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>  character_id;</span></code></pre></div>
      <p>上記の SQL の <strong>第09行目</strong> から <strong>第14行目</strong>
      のように、親クエリの内部に「入れ子」で記述された <code>SELECT</code> 文を
      <strong><em>サブクエリ</em></strong> といいます。サブクエリは必ず <span
      class="masked">括弧で囲む必要がある</span> ので注意してください。</p>
      <p>実際に SQL を実行し、先の場合と同じく以下の結果が得られることを確認してください。</p>
      <pre><code> character_id |  name   | job_id
--------------+---------+--------
            1 | Marvin  |      5
            3 | Charlie |      6
            6 | Alice   |      5
           11 | Ellen   |      6
           13 | Mallet  |      6
           15 | Trent   |      5
           18 | Carol   |      5
           19 | Jack    |      6
(8 行)</code></pre>
      <h2 data-number="3.2" id="select句におけるサブクエリの利用"><span
      class="header-section-number">3.2</span> SELECT句におけるサブクエリの利用</h2>
      <p>サブクエリは <code>WHERE</code> 句 だけではなく、<code>SELECT句</code>
      でも利用することができます。<code>SELECT</code> 句で利用すれば、先の結果セットに <span
      class="masked">Wizard や Priest といった「ジョブ名」をあわせて出力すること</span>
      も可能になります。</p>
      <p>ただし、通常、このような処理は、後のセクションで学ぶ <strong>結合</strong>
      (<code>JOIN</code>)
      を使用したほうが、<u>記述がシンプルとなり、さらに実行効率の面でも有利になる場合が多いので注意</u>
      してください。</p>
      <div class="sourceCode" id="cb13" data-caption="SELECT句にサブクエリを用いた例"><pre
      class="sourceCode numberSource sql numberLines"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">SELECT</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  character_id,</span>
<span id="cb13-3"><a href="#cb13-3"></a>  name,</span>
<span id="cb13-4"><a href="#cb13-4"></a>  job_id,</span>
<span id="cb13-5"><a href="#cb13-5"></a>  (</span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="kw">SELECT</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>      name</span>
<span id="cb13-8"><a href="#cb13-8"></a>    <span class="kw">FROM</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>      x_jobs</span>
<span id="cb13-10"><a href="#cb13-10"></a>    <span class="kw">WHERE</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>      job_id <span class="op">=</span> x_characters.job_id</span>
<span id="cb13-12"><a href="#cb13-12"></a>  ) <span class="kw">AS</span> job_name</span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="kw">FROM</span></span>
<span id="cb13-14"><a href="#cb13-14"></a>  x_characters</span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="kw">WHERE</span></span>
<span id="cb13-16"><a href="#cb13-16"></a>  job_id <span class="kw">IN</span> (</span>
<span id="cb13-17"><a href="#cb13-17"></a>    <span class="kw">SELECT</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>      job_id</span>
<span id="cb13-19"><a href="#cb13-19"></a>    <span class="kw">FROM</span></span>
<span id="cb13-20"><a href="#cb13-20"></a>      x_jobs</span>
<span id="cb13-21"><a href="#cb13-21"></a>    <span class="kw">WHERE</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>      name <span class="kw">IN</span> (<span class="st">&#39;Wizard&#39;</span>, <span class="st">&#39;Priest&#39;</span>)</span>
<span id="cb13-23"><a href="#cb13-23"></a>  )</span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb13-25"><a href="#cb13-25"></a>  job_id,</span>
<span id="cb13-26"><a href="#cb13-26"></a>  character_id;</span></code></pre></div>
      <p>実行結果は次のようになります。</p>
      <pre><code> character_id |  name   | job_id | job_name 
--------------+---------+--------+----------
            1 | Marvin  |      5 | Priest
            6 | Alice   |      5 | Priest
           15 | Trent   |      5 | Priest
           18 | Carol   |      5 | Priest
            3 | Charlie |      6 | Wizard
           11 | Ellen   |      6 | Wizard
           13 | Mallet  |      6 | Wizard
           19 | Jack    |      6 | Wizard
(8 行)</code></pre>
      <p>なお、この SQL の <strong>第11行目</strong> ように <u>外側 (親側) のクエリのカラム
      (x_characters.job_id) を参照するサブクエリ</u> は <strong><em>相関サブクエリ</em></strong>
      (<strong>Correlated Subquery</strong>) と呼ばれます。</p>
      <ul>
      <li><strong>第17行目</strong> から <strong>第22行目</strong>
      のサブクエリは、外側のカラムのクエリを参照していないので、<u>相関サブクエリではありません</u>。</li>
      </ul>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>SQLに関する質問です。「サブクエリ」と「相関サブクエリ」の違いがいまいち分かりません。SELECT句に用いるものを「サブクエリ」、WHERE句に用いるものを「相関サブクエリ」というのですか🤔</p>
      </blockquote>
      <h2 data-number="3.3" id="サブクエリを利用する場合の注意点"><span
      class="header-section-number">3.3</span> サブクエリを利用する場合の注意点</h2>
      <p>式として使うサブクエリは、外側のクエリから見ると「<strong>スカラー値</strong>」または「<strong>スカラー値の集合</strong>」として扱われます。そのため、原則として
      <span class="masked">「1カラムの1レコード」または「1カラムの複数レコード」</span>
      の結果セットを返すような <code>SELECT</code> 文を記述します。</p>
      <p>サブクエリとして <strong>複数のカラム</strong> を含む結果セットを返す <code>SELECT</code>
      を記述すると次のようなエラーが発生します。</p>
      <pre><code>psql:&lt;stdin&gt;:XX: ERROR:  副問い合わせは1列のみを返さなければなりません</code></pre>
      <p>また、単一のスカラー値が期待されている箇所で、サブクエリとして
      <strong>複数のレコード</strong> を返す <code>SELECT</code>
      を記述すると、次のようなエラーが発生します。</p>
      <pre><code>psql:&lt;stdin&gt;:XX: ERROR:  式として使用された副問い合わせが2行以上の行を返しました</code></pre>
      <p>たとえば、<code>WHERE job_id IN ( SELECT ... )</code> のように <code>IN</code>
      キーワードによって「<strong>スカラー値の集合</strong>」が期待される場合は、複数のレコードを返すサブクエリを記述しても問題ありません。</p>
      <p>一方で、<code>WHERE job_id = ( SELECT ... )</code>
      のような「<strong>単一のスカラー値</strong>」が期待される場合は、<span class="masked">必ず
      1レコードのみ を返すサブクエリ</span> を記述する必要があります。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>SQLに関する質問です。式として使用するサブクエリは、スカラー値 (1カラム1レコード) または
      スカラー値の集合 (1カラム複数レコード)
      を返す必要がある、と言われました。意味が分かりません。どういうことですか？丁寧に解説してください。</p>
      </blockquote>
      <div class="note type-senior">
      <p><strong>補足</strong></p>
      <p>ここでは <code>WHERE</code> 句 や <code>SELECT</code>
      句の「<strong>式として使うサブクエリ</strong>」に絞って説明しています。</p>
      <p><code>FROM</code> 句 において <code>FROM ( SELECT ... )</code>
      のように「表」として扱うサブクエリは「複数カラムの複数レコード」を返すように記述することができます。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>SQLに関する質問です。サブクエリは、<code>WHERE</code> 句 や <code>SELECT</code> 句
      で使うことが多いが、<code>FROM</code>
      句でも使用できると聞きました。どのような使い道があるのか教えてください。</p>
      </blockquote>
      </div>
      <h3 data-number="3.3.1" id="sqlドリル-1"><span class="header-section-number">3.3.1</span>
      SQLドリル💻</h3>
      <p>やや難易度の高い問題も含まれているため、数分考えても解決しない場合は、解答例（演習環境の
      from-teacher/10/drill）を参照して理解してください。そのうえで、必ず自分で SQL
      を書き直してみてください。</p>
      <div class="note type-tips">
      <p>解答例を見て「分かった」と感じても、実際に SQL
      を書けない場合、それは理解できているのではなく <strong>理解したという錯覚</strong>
      に陥っているだけです。注意してください。</p>
      </div>
      <ul>
      <li><code>ex-02_1.sql</code> 👉 x_items
      テーブルから、どのキャラも所持していないアイテムを抽出し、次のような結果セットを得るような SQL
      を記述せよ (item_id の昇順で整列すること)。ただし、結合ではなくサブクエリを用いた SQL
      とすること。</li>
      </ul>
      <pre><code> item_id |     name      |   description    
---------+---------------+------------------
       4 | Giga Potion   | 単体HPを完全回復
       8 | Paralyze Cure | 麻痺状態を回復</code></pre>
      <ul>
      <li><code>ex-02_2.sql</code> 👉 x_items テーブルから、全キャラクタを通算した所持数量の合計が 5
      個以下であるアイテムを抽出し、次のような結果セットを得るような SQL
      を記述せよ。ただし、結合ではなくサブクエリを用いた SQL とすること。</li>
      </ul>
      <pre><code> item_id |       name       |     description      
---------+------------------+----------------------
       2 | High Potion      | 単体HPを中回復
       3 | Mega Potion      | 単体HPを大回復
       4 | Giga Potion      | 単体HPを完全回復
       6 | High Mana Potion | 単体MPを大回復
       8 | Paralyze Cure    | 麻痺状態を回復
      12 | Climbing Rope    | 崖や段差を乗り越える</code></pre>
      <ul>
      <li><code>ex-02_3.sql</code> 👉 x_characters
      テーブルから、どのギルドにも所属していないキャラクタを抽出し、次のような結果セットを得るような
      SQL を記述せよ。ただし、結合ではなくサブクエリを用いた SQL とすること。</li>
      </ul>
      <pre><code> character_id |  name   |     deleted_at      
--------------+---------+---------------------
            3 | Charlie | 
            4 | Tom     | 
            5 | Ivan    |
            9 | Walter  | 2023-08-31 07:10:00
           18 | Carol   |</code></pre>
      <ul>
      <li><code>ex-02_4.sql</code> 👉 x_characters テーブルから、ジョブが Wizard または Priest
      のキャラクタ (ただし、deleted_at が NULL のみ) を抽出し、次のような結果セットを得るような SQL
      を記述せよ。ただし、結合ではなくサブクエリを用いた SQL とすること。</li>
      </ul>
      <pre><code> character_id |  name   | job_id | deleted_at 
--------------+---------+--------+------------
            1 | Marvin  |      5 |
            3 | Charlie |      6 |
            6 | Alice   |      5 |
           11 | Ellen   |      6 |
           13 | Mallet  |      6 |
           18 | Carol   |      5 |
           19 | Jack    |      6 |</code></pre>
      <ul>
      <li><code>ex-02_5.sql</code> 👉 x_items テーブルから、所持しているキャラクタの人数が 2
      名以下であるアイテムを抽出し、次のような結果セットを得るような SQL
      を記述せよ。ただし、結合ではなくサブクエリを用いた SQL とすること。
      <ul>
      <li><strong>ヒント</strong>: サブクエリで COUNT と HAVING を利用</li>
      </ul></li>
      </ul>
      <pre><code> item_id |     name      |     description      
---------+---------------+----------------------
       2 | High Potion   | 単体HPを中回復
       4 | Giga Potion   | 単体HPを完全回復
       8 | Paralyze Cure | 麻痺状態を回復
      12 | Climbing Rope | 崖や段差を乗り越える</code></pre>
      <ul>
      <li><code>ex-02_6.sql</code> 👉 x_items
      テーブルから、重量が最大のものを抽出し、次のような結果セットを得るような SQL
      を記述せよ。ただし、結合ではなくサブクエリを用いた SQL とすること。</li>
      </ul>
      <pre><code> item_id |     name      | weight_kg |     description      
---------+---------------+-----------+----------------------
      11 | Torch         |       1.5 | 洞窟内を明るく照らす
      12 | Climbing Rope |       1.5 | 崖や段差を乗り越える</code></pre>
      <ul>
      <li><code>ex-02_7.sql</code> 👉
      各キャラクタが所持するアイテム種類数を集計し、次のような結果セットを得るような SQL
      を記述せよ。ただし、結合ではなくサブクエリを用いた SQL とすること。
      <ul>
      <li><strong>ヒント</strong>: SELECT句で相関サブクエリを使用</li>
      </ul></li>
      </ul>
      <pre><code> character_id |  name   | item_kinds 
--------------+---------+------------
            1 | Marvin  |          3
            2 | Zach    |          2
            3 | Charlie |          2
            4 | Tom     |          1
            5 | Ivan    |          2
            6 | Alice   |          3
            7 | Trudy   |          3
            8 | Bob     |          0
            9 | Walter  |          4
 ～～以下略～～</code></pre>
      <h1 data-number="4" id="内部結合"><span class="header-section-number">4</span> 内部結合</h1>
      <div class="note type-tips">
      <p>以下、鋭意制作中…⏳</p>
      </div>
      <h1 data-number="5" id="授業時間外学習の指示"><span class="header-section-number">5</span>
      授業時間外学習の指示</h1>
      <p>🚨<strong>本科目は「学修単位科目」であり、1回の講義あたり「4時間相当」の授業時間外学習が求められる科目です</strong>🏃</p>
      <ul>
      <li>次回の講義で「<strong>小テスト❽</strong>」を実施します。
      <ul>
      <li>主に <strong>SQLドリル</strong>、<strong>定着確認</strong>、<strong>演習</strong>
      から出題します。</li>
      </ul></li>
      </ul>
      <hr />
      <ul>
      <li>この講義資料を再読・熟読し「不明な用語」や「理解が不十分な用語」があればインターネットや、ChatGPTなどの生成AIを利用して解決してください。また、興味関心を持ったトピックについて、ウェブ、生成AI、YouTube動画などを利用して知識を広げ、理解を深めてください。
      <ul>
      <li>特に <strong>(プロンプト例)</strong>
      を示しているものについては、実際に生成AIにプロンプトを投げ、さらに対話を重ねることで、知識の幅を広げるだけでなく、理解をより深く確かなものにしてください。</li>
      </ul></li>
      <li>講義資料内の「<strong>演習</strong>」や「<strong>SQLドリル</strong>」に再度取り組んでください。特に、<strong>SQLドリル</strong>💻
      は、授業時間中に1回取り組むだけでは定着しないので注意してください。</li>
      </ul>
      <!-- ---------------------------------------- -->
    </main>

    <footer class="markdown-body">
      <p><a href="https://takeshiwada1980.github.io/DB-2025/">講義資料のIndexに移動</a></p>
    </footer>

    <script>
      window.onload = function () {
        // ナビゲーション関連
        let openBtn = document.getElementsByClassName("openbtn")[0];
        let navPnl = document.getElementById("g-nav");
        openBtn.onclick = () => {
          openBtn.classList.toggle("active");
          navPnl.classList.toggle("panelactive");
        };

        let items = navPnl.getElementsByTagName("a");
        Array.from(items).forEach((item) => {
          item.onclick = () => {
            openBtn.classList.toggle("active");
            navPnl.classList.toggle("panelactive");
          };
        });

        // マスク処理
        let maskedSpans = document.getElementsByClassName("masked");
        Array.from(maskedSpans).forEach((span) => {
          span.onclick = () => {
            span.classList.toggle("open");
          };
        });

        // data-startfrom 属性の行番号カウンタのリセット
        document.querySelectorAll("div.sourceCode").forEach(function (div) {
          var startFrom = div.getAttribute("data-startfrom");
          if (startFrom != null) {
            div.style.counterReset = "pg-line " + (startFrom - 1);
          }
        });

        // 画像にリンクを付与
        // let images = document.querySelectorAll("figure img");
        // Array.from(images).forEach((img) => {
        //   img.onclick = () => {
        //     location.href = img.getAttribute("src");
        //   };
        // });
      };
    </script>
  </body>
</html>
